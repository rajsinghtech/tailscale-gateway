---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.16.5
  name: tailscaleroutepolicies.gateway.tailscale.com
spec:
  group: gateway.tailscale.com
  names:
    kind: TailscaleRoutePolicy
    listKind: TailscaleRoutePolicyList
    plural: tailscaleroutepolicies
    singular: tailscaleroutepolicy
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - description: Status of the route policy.
      jsonPath: .status.conditions[?(@.type == "Ready")].reason
      name: Status
      type: string
    - description: Target gateway.
      jsonPath: .spec.targetRefs[0].name
      name: Gateway
      type: string
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          TailscaleRoutePolicy defines advanced routing policies for tailnet traffic
          through Envoy Gateway, supporting conditions, transformations, and actions.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: TailscaleRoutePolicySpec defines the desired routing policy
            properties:
              rules:
                description: Rules define the routing policy rules to apply.
                items:
                  description: PolicyRule defines a single routing policy rule
                  properties:
                    actions:
                      description: Actions define what should happen when this rule
                        matches.
                      items:
                        description: PolicyAction defines an action to take when a
                          rule matches
                        properties:
                          redirect:
                            description: Redirect configures HTTP redirect responses.
                            properties:
                              hostname:
                                description: Hostname is the hostname to redirect
                                  to.
                                type: string
                              path:
                                description: Path configures path replacement for
                                  redirects.
                                properties:
                                  type:
                                    description: Type specifies how to replace the
                                      path.
                                    enum:
                                    - ReplaceFullPath
                                    - ReplacePrefixMatch
                                    type: string
                                  value:
                                    description: Value is the replacement value.
                                    type: string
                                required:
                                - type
                                - value
                                type: object
                              port:
                                description: Port is the port to redirect to.
                                format: int32
                                maximum: 65535
                                minimum: 1
                                type: integer
                              scheme:
                                description: Scheme is the scheme to redirect to.
                                type: string
                              statusCode:
                                description: StatusCode is the HTTP status code for
                                  the redirect.
                                enum:
                                - 301
                                - 302
                                format: int32
                                type: integer
                            type: object
                          requestHeaderModifier:
                            description: RequestHeaderModifier configures request
                              header modifications.
                            properties:
                              add:
                                description: Add configures headers to add, preserving
                                  existing values.
                                items:
                                  description: Header represents an HTTP header
                                  properties:
                                    name:
                                      description: Name is the header name.
                                      type: string
                                    value:
                                      description: Value is the header value.
                                      type: string
                                  required:
                                  - name
                                  - value
                                  type: object
                                type: array
                              remove:
                                description: Remove configures headers to remove.
                                items:
                                  type: string
                                type: array
                              set:
                                description: Set configures headers to set, overwriting
                                  existing values.
                                items:
                                  description: Header represents an HTTP header
                                  properties:
                                    name:
                                      description: Name is the header name.
                                      type: string
                                    value:
                                      description: Value is the header value.
                                      type: string
                                  required:
                                  - name
                                  - value
                                  type: object
                                type: array
                            type: object
                          responseHeaderModifier:
                            description: ResponseHeaderModifier configures response
                              header modifications.
                            properties:
                              add:
                                description: Add configures headers to add, preserving
                                  existing values.
                                items:
                                  description: Header represents an HTTP header
                                  properties:
                                    name:
                                      description: Name is the header name.
                                      type: string
                                    value:
                                      description: Value is the header value.
                                      type: string
                                  required:
                                  - name
                                  - value
                                  type: object
                                type: array
                              remove:
                                description: Remove configures headers to remove.
                                items:
                                  type: string
                                type: array
                              set:
                                description: Set configures headers to set, overwriting
                                  existing values.
                                items:
                                  description: Header represents an HTTP header
                                  properties:
                                    name:
                                      description: Name is the header name.
                                      type: string
                                    value:
                                      description: Value is the header value.
                                      type: string
                                  required:
                                  - name
                                  - value
                                  type: object
                                type: array
                            type: object
                          route:
                            description: Route configures routing to a specific backend.
                            properties:
                              backendRefs:
                                description: BackendRefs are the backends to route
                                  traffic to.
                                items:
                                  description: BackendRef references a backend service
                                  properties:
                                    group:
                                      default: ""
                                      description: |-
                                        Group is the group of the referent. For example, "gateway.networking.k8s.io".
                                        When unspecified or empty string, core API group is inferred.
                                      maxLength: 253
                                      pattern: ^$|^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$
                                      type: string
                                    kind:
                                      default: Service
                                      description: |-
                                        Kind is the Kubernetes resource kind of the referent. For example
                                        "Service".

                                        Defaults to "Service" when not specified.

                                        ExternalName services can refer to CNAME DNS records that may live
                                        outside of the cluster and as such are difficult to reason about in
                                        terms of conformance. They also may not be safe to forward to (see
                                        CVE-2021-25740 for more information). Implementations SHOULD NOT
                                        support ExternalName Services.

                                        Support: Core (Services with a type other than ExternalName)

                                        Support: Implementation-specific (Services with type ExternalName)
                                      maxLength: 63
                                      minLength: 1
                                      pattern: ^[a-zA-Z]([-a-zA-Z0-9]*[a-zA-Z0-9])?$
                                      type: string
                                    name:
                                      description: Name is the name of the referent.
                                      maxLength: 253
                                      minLength: 1
                                      type: string
                                    namespace:
                                      description: |-
                                        Namespace is the namespace of the backend. When unspecified, the local
                                        namespace is inferred.

                                        Note that when a namespace different than the local namespace is specified,
                                        a ReferenceGrant object is required in the referent namespace to allow that
                                        namespace's owner to accept the reference. See the ReferenceGrant
                                        documentation for details.

                                        Support: Core
                                      maxLength: 63
                                      minLength: 1
                                      pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                                      type: string
                                    port:
                                      description: |-
                                        Port specifies the destination port number to use for this resource.
                                        Port is required when the referent is a Kubernetes Service. In this
                                        case, the port number is the service port number, not the target port.
                                        For other resources, destination port might be derived from the referent
                                        resource or this field.
                                      format: int32
                                      maximum: 65535
                                      minimum: 1
                                      type: integer
                                    weight:
                                      description: Weight configures the weight for
                                        load balancing.
                                      format: int32
                                      type: integer
                                  required:
                                  - name
                                  type: object
                                  x-kubernetes-validations:
                                  - message: Must have port for Service reference
                                    rule: '(size(self.group) == 0 && self.kind ==
                                      ''Service'') ? has(self.port) : true'
                                type: array
                              timeout:
                                description: Timeout configures timeouts for this
                                  route.
                                properties:
                                  backendRequest:
                                    description: BackendRequest is the timeout for
                                      backend requests.
                                    type: string
                                  request:
                                    description: Request is the timeout for the entire
                                      request.
                                    type: string
                                type: object
                            required:
                            - backendRefs
                            type: object
                          type:
                            description: Type specifies the type of action to take.
                            enum:
                            - Route
                            - Redirect
                            - Deny
                            - RequestHeaderModifier
                            - ResponseHeaderModifier
                            type: string
                        required:
                        - type
                        type: object
                      type: array
                    matches:
                      description: Matches define when this rule should be applied.
                      items:
                        description: PolicyMatch defines conditions for when a rule
                          should apply
                        properties:
                          headers:
                            description: Headers matches based on request headers.
                            items:
                              description: HeaderMatch matches based on request headers
                              properties:
                                name:
                                  description: Name is the header name to match.
                                  type: string
                                type:
                                  description: Type specifies how to match the header.
                                  enum:
                                  - Exact
                                  - RegularExpression
                                  type: string
                                value:
                                  description: Value is the header value to match
                                    against.
                                  type: string
                              required:
                              - name
                              - type
                              - value
                              type: object
                            type: array
                          method:
                            description: Method matches based on HTTP method.
                            properties:
                              methods:
                                description: Methods are the HTTP methods to match.
                                enum:
                                - GET
                                - HEAD
                                - POST
                                - PUT
                                - DELETE
                                - CONNECT
                                - OPTIONS
                                - TRACE
                                - PATCH
                                items:
                                  description: HTTPMethod represents an HTTP method
                                  type: string
                                type: array
                            required:
                            - methods
                            type: object
                          path:
                            description: Path matches based on the request path.
                            properties:
                              type:
                                description: Type specifies how to match the path.
                                enum:
                                - Exact
                                - PathPrefix
                                - RegularExpression
                                type: string
                              value:
                                description: Value is the path value to match against.
                                type: string
                            required:
                            - type
                            - value
                            type: object
                          tailnetDevice:
                            description: TailnetDevice matches based on characteristics
                              of the source tailnet device.
                            properties:
                              hostnames:
                                description: |-
                                  Hostnames matches devices by hostname patterns.
                                  Supports wildcards (*) for pattern matching.
                                items:
                                  type: string
                                type: array
                              ips:
                                description: |-
                                  IPs matches devices by their tailnet IP addresses.
                                  Supports CIDR notation for network ranges.
                                items:
                                  type: string
                                type: array
                              tags:
                                description: Tags matches devices that have any of
                                  the specified tags.
                                items:
                                  type: string
                                type: array
                              users:
                                description: Users matches devices owned by specific
                                  users.
                                items:
                                  type: string
                                type: array
                            type: object
                        type: object
                      type: array
                    name:
                      description: Name is an optional name for this rule for debugging
                        purposes.
                      type: string
                  required:
                  - actions
                  type: object
                type: array
              targetRefs:
                description: |-
                  TargetRefs identifies the targets that this policy applies to.
                  Can target Gateways, HTTPRoutes, or TailscaleGateways.
                items:
                  description: LocalPolicyTargetReference identifies a target for
                    policy attachment
                  properties:
                    group:
                      description: Group is the group of the target resource.
                      maxLength: 253
                      pattern: ^$|^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$
                      type: string
                    kind:
                      description: Kind is the kind of the target resource.
                      maxLength: 63
                      minLength: 1
                      pattern: ^[a-zA-Z]([-a-zA-Z0-9]*[a-zA-Z0-9])?$
                      type: string
                    name:
                      description: Name is the name of the target resource.
                      maxLength: 253
                      minLength: 1
                      type: string
                    namespace:
                      description: Namespace is the namespace of the target resource.
                      maxLength: 63
                      minLength: 1
                      pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                      type: string
                    sectionName:
                      description: SectionName is the name of a section within the
                        target resource.
                      maxLength: 253
                      minLength: 1
                      pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$
                      type: string
                  required:
                  - group
                  - kind
                  - name
                  type: object
                type: array
            required:
            - rules
            - targetRefs
            type: object
          status:
            description: TailscaleRoutePolicyStatus defines the observed state of
              TailscaleRoutePolicy
            properties:
              appliedTo:
                description: AppliedTo indicates which targets this policy has been
                  successfully applied to.
                items:
                  description: PolicyTargetStatus represents the status of policy
                    application to a target
                  properties:
                    applied:
                      description: Applied indicates if the policy was successfully
                        applied.
                      type: boolean
                    message:
                      description: Message contains additional information about the
                        application status.
                      type: string
                    targetRef:
                      description: TargetRef is the reference to the target.
                      properties:
                        group:
                          description: Group is the group of the target resource.
                          maxLength: 253
                          pattern: ^$|^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$
                          type: string
                        kind:
                          description: Kind is the kind of the target resource.
                          maxLength: 63
                          minLength: 1
                          pattern: ^[a-zA-Z]([-a-zA-Z0-9]*[a-zA-Z0-9])?$
                          type: string
                        name:
                          description: Name is the name of the target resource.
                          maxLength: 253
                          minLength: 1
                          type: string
                        namespace:
                          description: Namespace is the namespace of the target resource.
                          maxLength: 63
                          minLength: 1
                          pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                          type: string
                        sectionName:
                          description: SectionName is the name of a section within
                            the target resource.
                          maxLength: 253
                          minLength: 1
                          pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$
                          type: string
                      required:
                      - group
                      - kind
                      - name
                      type: object
                  required:
                  - applied
                  - targetRef
                  type: object
                type: array
              conditions:
                description: Conditions represent the current state of the policy.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
